<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<!--
Element providing translation of text.

##### Example

    <x-translate></x-translate>

    <h1> translate="HEADER">I will take the value of HEADER.</h1>
    <p> translate="ABOUT">I'll become the value of the ABOUT key.</h1>

@element x-translate
@blurb Element providing translation of text.
@status alpha
@homepage https://github.com/tryggvigy/x-translate
-->
<polymer-element name="x-translate" attributes="uses">

  <template>
    <core-ajax
      url=""
      handleAs="json">
    </core-ajax>
  </template>

  <script>
  (function () {
      'use strict';

    Polymer({

      ready: function() {
        this.targets = getTranslateTargets();
        checkForJSON(this);
      },

      /**
       * The `use` method will translate the text content of all elements marked
       * with a translation key if it can find said key in the newLang parameter.
       *
       * This function can handle three cases.
       * <ol>
       *   <li>.use(any javascript object);</li>
       *   <li>.use('default');</li>
       *   <li>.use('json');</li>
       * </ol>
       * See the demo-page, where each case is shown respectfully.
       *
       * @method use
       * @param {Object|String} newLang The new language definition, or a hint for where it can be found.
       */
      use: function(newLang) {

        // case: default
        if(newLang === 'default')
          return setDefaultLang(this.targets);

        // case: json
        else if(newLang === 'json') {
          //save reference to x-translate element to use in the eventListener.
          var xTranslate = this;

          this.ajax.addEventListener("core-response",
            function(e) {
              newLang = e.detail.response;
              setLang(xTranslate.targets, newLang);
            }
          );
          this.ajax.addEventListener("core-error",
            function(e) {
              var err = Error(e.detail.response);
              console.error(err.stack);
            }
          );

          //fire off the ajax request.
          this.ajax.go();
        }

        //case: javascript object
        else if(newLang !== null && typeof newLang === 'object') {
          setLang(this.targets, newLang);
        }

        //if no cases trigger, log an error.
        else {
          var err = Error('Case not recognized.');
          console.error(err.stack);
          return err;
        }

      }

    });

    function getTranslateTargets() {
      // fetch all elements with the translate attribute.
      var elems = document.querySelectorAll('[translate]');

      // construct the translateData array from the htmlCollection array.
      var translateData = [].map.call(elems, function(currEl) {
        return {
          elem : currEl,
          key  : currEl.getAttribute('translate'),
          default : currEl.textContent
        }
      });
      return translateData;
    }

    function setDefaultLang(targets) {
      targets.forEach(function(target) {
        target.elem.textContent = target.default;
      });
    }

    function setLang(targets, lang) {
      targets.map(function(currTarget) {
        var target = currTarget;

        Object.keys(lang).forEach(function(currKey) {
          if (target.key === currKey) {
            target.elem.textContent = lang[currKey];
          }
          return target;
        });

        return target;
      });
    }

    function checkForJSON(xTranslate) {
      var ajax = xTranslate.shadowRoot.querySelector('core-ajax');

      if(!xTranslate.uses || xTranslate.uses === '') {
        //no json is being used.
        return;
      }

      ajax.setAttribute('url', xTranslate.uses);

      xTranslate.ajax = ajax;
    }

  })();

  </script>

</polymer-element>
